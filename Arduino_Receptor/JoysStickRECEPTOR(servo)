#include <SoftwareSerial.h>
#include <Servo.h>

Servo servo;

float pos = 90;
float velBase = 2.0;
float velMax = 6.0;
float velMin = 0.5;
float velocidadActual = velBase;
int direccion = 1;

bool modoDirecto = false;
int xVal = 512;

#define LORA_RX 10
#define LORA_TX 11
SoftwareSerial LoRaSerial(LORA_RX, LORA_TX);

char buffer[32];
int bufIndex = 0;

void setup() {
  servo.attach(9);
  Serial.begin(9600);
  LoRaSerial.begin(9600);
  Serial.println("Receptor robusto listo");
}

void loop() {
  // Leer bytes del UART
  while (LoRaSerial.available()) {
    char c = LoRaSerial.read();

    if (c == '\n') { // fin de paquete
      buffer[bufIndex] = '\0'; // terminar string
      bufIndex = 0;

      // Parsear modo y valor
      char *token = strtok(buffer, ",");
      if (token != NULL) {
        int modo = atoi(token);
        token = strtok(NULL, ",");
        if (token != NULL) {
          int val = atoi(token);

          // Validar rango
          if (val >= 0 && val <= 1023) {
            modoDirecto = (modo == 1);
            xVal = val;
            Serial.print("Recibido -> Modo: "); Serial.print(modoDirecto ? 1 : 0);
            Serial.print(" | xVal: "); Serial.println(xVal);
          }
        }
      }
    } else {
      // Guardar byte en buffer
      if (bufIndex < sizeof(buffer) - 1) {
        buffer[bufIndex++] = c;
      } else {
        // overflow de buffer, reset
        bufIndex = 0;
      }
    }
  }

  // -----------------------
  // MODO 1: automÃ¡tico
  // -----------------------
  if (!modoDirecto) {
    int diff = xVal - 512;
    if (diff != 0) {
      float factor = (float)abs(diff)/511.0;
      float deltaVel = factor * 0.2;
      if (diff > 0) {
        velocidadActual += deltaVel;
        if (velocidadActual > velMax) velocidadActual = velMax;
      } else {
        velocidadActual -= deltaVel;
        if (velocidadActual < velMin) velocidadActual = velMin;
      }
    }

    pos += direccion * velocidadActual;
    if (pos >= 180) { pos = 180; direccion = -1; }
    if (pos <= 0) { pos = 0; direccion = 1; }

    servo.write(pos);
  }

  // -----------------------
  // MODO 2: control directo
  // -----------------------
  else {
    float posTarget = map(xVal, 0, 1023, 0, 180);
    float alpha = 0.1;
    float posActual = servo.read();
    pos = posActual + alpha * (posTarget - posActual);
    servo.write(pos);
  }

  delay(20);
}
